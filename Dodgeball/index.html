<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>DodgeBall</title>
    <script src="js/phaser.min.js"></script>
    <link rel="stylesheet" href="css/master.css">
  </head>
  <body>
    <script type="text/javascript">
      var game = new Phaser.Game(800, 600, Phaser.CANVAS, null, {preload:preload, create:create, update:update});

      var box, player, inputKey, ball, ballAlive, score, score_Event, gameover_Text;
      var ballArray = [];
      var playerLife = 1;
      var score_num = 0;

      function preload(){
        game.load.image('box', 'assets/images/blank.png');
        game.load.image('player', 'assets/images/player.png');
        game.load.image('ball', 'assets/images/ball.png');
      };
      function create(){
        game.physics.startSystem(Phaser.Physics.ARCADE);
        game.stage.backgroundColor = "#000000";
        game.create.texture('score', ['0'], 800, 80, 0);
        // game.add.sprite(0, 0, 'score');
        score = game.add.group();
        score.enableBody = true;
        score.create(0, 0, 'score');

        box = game.add.group();
        box.enableBody = true;
        for (var i = 0; i < 20; i ++) {
          box.create(i*40, 80, 'box').body.immovable=true;
          box.create(i*40, 600-40, 'box').body.immovable=true;
        }
        for (var j = 3; j < 14; j++) {
          box.create(0, j * 40, 'box').body.immovable=true;
          box.create(800-40, j*40, 'box').body.immovable=true;
        }
        player = game.add.sprite(400, 300, 'player');
        // player.scale.x = 0.2;
        // player.scale.y = 0.2;
        player.anchor.setTo(0.5, 0.5);
        game.physics.arcade.enable(player);

        ball = game.add.group();
        ball.enableBody = true;
        ball.physicsBodyType = Phaser.Physics.ARCADE;
        ball.createMultiple(30, "ball");
        ball.setAll('outofBoundsKill', true);
        ball.setAll('checkWorldBounds', true);

        inputKey = game.input.keyboard.createCursorKeys();

        var score_text=game.add.text(20, 10, 'SCORE 0', {fontSize:'50px', fill:'#FFFFFF'});
        score_Event = game.time.events.loop(Phaser.Timer.SECOND, function(){
          score_num++;
          score_text.setText("SCORE " + score_num);
        }, this);

        gameover_Text = game.add.text(game.world.centerX, game.world.centerY, 'GAME OVER', {fontSize: '80px', fill: '#FFFFFF'});
        gameover_Text.anchor.setTo(0.5, 0.5);
        gameover_Text.visible = false;
      };
      function update(){
        game.physics.arcade.collide(player, box);
        game.physics.arcade.overlap(score, ball, function(sky, ball){
          ball.kill();
        }, null, this);
        game.physics.arcade.overlap(player, ball, function(player, ball){
          ball.kill();
          playerLife--;
        }, null, this);

        var velocity = 200;

        player.body.velocity.setTo(0, 0);

        if (playerLife < 1) {
          game.time.events.remove(score_Event);
          gameover_Text.visible = true;
          return
        }

        if (inputKey.left.isDown && inputKey.up.isDown) {
          player.body.velocity.x = -velocity;
          player.body.velocity.y = -velocity;
        } else if (inputKey.left.isDown && inputKey.down.isDown) {
          player.body.velocity.x = -velocity;
          player.body.velocity.y = +velocity;
        } else if (inputKey.right.isDown && inputKey.up.isDown) {
          player.body.velocity.x = +velocity;
          player.body.velocity.y = -velocity;
        } else if (inputKey.right.isDown && inputKey.down.isDown) {
          player.body.velocity.x = +velocity;
          player.body.velocity.y = +velocity;
        } else if (inputKey.left.isDown) {
          player.body.velocity.x = -velocity;
        } else if (inputKey.right.isDown) {
          player.body.velocity.x = +velocity;
        } else if (inputKey.up.isDown) {
          player.body.velocity.y = -velocity;
        } else if (inputKey.down.isDown) {
          player.body.velocity.y = +velocity;
        }

        ballAlive=ball.getFirstExists(false);
        ballArray.length = 0;
        box.forEachAlive(function(ballAlive) {
          ballArray.push(ballAlive);
        });
        if (ballAlive && ballArray.length > 0) {
          var ballRandom = game.rnd.integerInRange(0, ballArray.length - 1);
          var ballBox = ballArray[ballRandom];
          ballAlive.reset(ballBox.body.x, ballBox.body.y);
          game.physics.arcade.moveToObject(ballAlive,player,150);
        }
      };
    </script>
  </body>
</html>
